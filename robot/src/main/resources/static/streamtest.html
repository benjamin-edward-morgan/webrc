<!DOCTYPE html>
<html>
<head>
<title>Websocket</title>
</head>

<!--<script src="/webjars/jquery/2.1.1/jquery.min.js"></script>-->


<!-- <script src="/webjars/cometd-jquery/2.3.1/jquery-1.6.2.js"></script> -->
<!--<script src="/webjars/cometd-jquery/2.3.1/json2.js"></script>-->

<!--<script src="/webjars/cometd/2.3.1/cometd.js"></script>-->

<!--<script src="/webjars/cometd-jquery/2.3.1/jquery.cometd.js"></script>-->

<!-- <script src="/webjars/cometd-jquery/2.3.1/jquery.cometd-reload.js"></script>
<script src="/webjars/cometd-jquery/2.3.1/jquery.cometd-timestamp.js"></script>
<script src="/webjars/cometd-jquery/2.3.1/jquery.cometd-ack.js"></script>
<script src="/webjars/cometd-jquery/2.3.1/jquery.cometd-timesync.js"></script> -->

<script src="jquery-1.11.0.js"></script>
<script src="cometd-namespace.js"></script>
<script src="cometd-json.js"></script>
<script src="Transport.js"></script>
<script src="TransportRegistry.js"></script>
<script src="LongPollingTransport.js"></script>
<script src="CallbackPollingTransport.js"></script>
<script src="WebSocketTransport.js"></script>
<script src="RequestTransport.js"></script>
<script src="Utils.js"></script>
<script src="Cometd.js"></script>
<script src="jquery.cometd.js"></script>


<script>
(function($)
		{
		    var cometd = $.cometd;

            var subscription = null;


            $(document).ready(function()
		    {
		        function _connectionEstablished()
		        {
		            $('#body').append('<div>CometD Connection Established</div>');
		        }

		        function _connectionBroken()
		        {
		            $('#body').append('<div>CometD Connection Broken</div>');
		        }

		        function _connectionClosed()
		        {
		            $('#body').append('<div>CometD Connection Closed</div>');
		        }
		        
		        function _handlemessage(message)
		        {
					console.log("recieved :" + message);
                    $('#body').append('<div>Server Says: ' + message.data.random + '</div>');
	                cometd.publish('/data', { name: 'fuck you' });
		        }

		        // Function that manages the connection status with the Bayeux server
		        var _connected = false;
		        function _metaConnect(message)
		        {
		            if (cometd.isDisconnected())
		            {
		                _connected = false;
		                _connectionClosed();
		                return;
		            }

		            var wasConnected = _connected;
		            _connected = message.successful === true;
		            if (!wasConnected && _connected)
		            {
		                _connectionEstablished();
		            }
		            else if (wasConnected && !_connected)
		            {
		                _connectionBroken();
		            }
		        }

		        // Function invoked when first contacting the server and
		        // when the server has lost the state of this client
		        function _metaHandshake(handshake)
		        {
		        	console.log("handshake!!!");
		            if (handshake.successful === true)
		            {
		            	console.log("successful");

		                console.log("subscribing....");
		                subscription = cometd.subscribe('/service/data', _handlemessage);
		                    // Publish on a service channel since the message is for the server only
		                cometd.publish('/service/data', { name: 'fuck you' });

		            }
		        }

		        // Disconnect when the page unloads
		        $(window).unload(function()
		        {
		            cometd.disconnect(true);
		        });

		        var cometURL = location.protocol + "//" + location.host + "/webrc/bayeux";
		        console.log(cometURL);
		        cometd.configure({
                    url: cometURL,
                    logLevel: 'debug'
                });

		        cometd.addListener('/meta/handshake', _metaHandshake);
		        cometd.addListener('/meta/connect', _metaConnect);

		        cometd.handshake();
//
//                function(Reply) {
//                    console.log("handshake reply" + Reply);
//
//                    if(Reply.successful === true) {
//
//                        console.log("subscribing....");
//                        subscription = cometd.subscribe('/data', function(message)
//                        {
//                            console.log("recieved :" + message);
//                            $('#body').append('<div>Server Says: ' + message.data.random + '</div>');
//                            cometd.publish('/service/data', { name: 'fuck you' });
//                        });
//                        // Publish on a service channel since the message is for the server only
//                        //cometd.publish('/service/data', { name: 'fuck you' });
//
//                    }
//                }
		    });
		})(jQuery);
</script>

<body>
    <div id="body"></div>

</body>
</html>